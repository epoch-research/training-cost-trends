name: Update Airtable

on:
  schedule:
    - cron: "0 14 * * 1"

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        type: choice
        required: true
        options:
          - edu-test
          - production
        default: edu-test

jobs:
  update_airtable:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'edu-test' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Calculate costs and upload to Airtable
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          uv run cost_analysis_standalone.py \
            --hardware-price-data airtable://${{ secrets.AIRTABLE_APP_ID }}/${{ secrets.AIRTABLE_HARDWARE_PRICE_TABLE_ID }} \
            --hardware-data airtable://${{ secrets.AIRTABLE_APP_ID }}/${{ secrets.AIRTABLE_HARDWARE_DATA_TABLE_ID }} \
            --models-data airtable://${{ secrets.AIRTABLE_APP_ID }}/${{ secrets.AIRTABLE_MODELS_DATA_TABLE_ID }} \
            --price-index-data fred://${{ vars.FRED_PRICE_INDEX_SERIES }} \
            --update-table airtable://${{ secrets.AIRTABLE_APP_ID }}/${{ secrets.AIRTABLE_MODELS_DATA_TABLE_ID }}

      - name: Upload result files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: |
            results/
            !results/**/cost_components.csv
